# [START cloudbuild]
substitutions:
  _APP: togglr-api-service
  _ART_BUCKET: constellation-nonprod-df-manifests
images: ['us.gcr.io/${PROJECT_ID}/${_APP}:${COMMIT_SHA}']
artifacts:
  objects:
      location: 'gs://${_ART_BUCKET}/${_APP}'
      paths: 
        - 'output/nonprod.yaml'
        - 'output/prod.yaml'
tags:
  - togglr
  - prod
  - nonprod
secrets:
- kmsKeyName: projects/constellation-nonprod/locations/global/keyRings/constellation-nonprod-infra-key-ring/cryptoKeys/constellation-nonprod-infra-crypto-key
  secretEnv:
    TOGGLR_NONPROD: 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
    TOGGLR_PROD: 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
steps:


# Enable Kaniko cache
- name: 'gcr.io/kaniko-project/executor:latest'
  args:
  - --destination=us.gcr.io/${PROJECT_ID}/${_APP}:${COMMIT_SHA}
  - --cache=true
  - --cache-ttl=6h

# Decrypt secrets and generate kubernetes manifests
- name: us.gcr.io/constellation-utils/tools-base-alp:latest
  id: Manifests
  secretEnv: 
    - 'TOGGLR_NONPROD'
    - 'TOGGLR_PROD'
  args:
    - 'bash'
    - '-c'
    - './scripts/cb-kubernetes.sh'
